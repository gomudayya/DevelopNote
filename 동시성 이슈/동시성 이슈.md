# 동시성 이슈

**동일 자원(데이터)에 여러 쓰레드가 접근해서, 해당 자원에 동시에 'write'를 하면서 발생한다.** 

**(read만 하면 발생하지 않는다)**

Race Condition 이라고도 함. 개발자의 의도와는 전혀 다른 치명적인 결과가 발생할 수 있다.

# 어플리케이션 자원에서 발생하는 Race Condition

**[ 부연 설명 ]**

DB에 있는 데이터가 아닌, 어플리케이션의 변수값에서 발생하는 RaceCondition 상황에 대한 이야기이다.

보통 인스턴스의 필드나 static같은 공용필드에서 발생하게 된다.

### 스프링과 동시성문제

**Spring 환경에서 개발한다면 인스턴스 필드 변경을 정말 주의해야한다.**

스프링은 멀티쓰레드 환경을 지원하기 때문에, 여러 요청이 서로 다른 쓰레드를 통해서 처리가 된다.

그리고 스프링 빈으로 등록된 객체는 싱글톤을 보장한다. 

위의 두가지를 정리해보면 "객체는 하나인데!! 그 객체 하나에 여러개의 쓰레드가 붙어서 코드가 돌아가는 것이다."

서두에서 말한 동시성 이슈의 상황과 정말 딱 떨어지지 않은가? 

이러한 상황은 어떤 쓰레드가 인스턴스의 필드의 값을 변경하게 되면, 동시에 다른 요청을 처리하고있는 다른 쓰레드에게 영향을 준다.

### 왜 인스턴스 필드(멤버 변수)만이죠?

동시성 문제는 지역변수에서는 발생하지 않는다.

**지역변수는 쓰레드마다 각각 다른 메모리 영역을 할당받기 때문**이다.

## 해결 방법

### 1. `synchronized` 키워드 사용하기

자바에서 `synchronized` 키워드가 적용된 메서드나 블록은 한 번에 하나의 쓰레드만 접근할 수 있도록 보장된다.

하지만 이건 썩 좋지 못한 방법 같다.

우선 첫째로, 한 번에 하나의 쓰레드만 접근하기 때문에 처리 속도가 느리다.

그리고 코드레벨에서 락을 걸고자 하면 자바에 다른 좋은 대체기능이 더 있는 것 같은데, 공부를 좀 해봐야겠다. 

### 2. `ThreadLocal` 사용하기

ThreadLocal은 각 쓰레드별로 전용 보관소를 만들어서 데이터를 보관한다.

지금 문제 상황은 여러 쓰레드가 같은 변수를 공유하기 때문에 write 작업이 다른 쓰레드에게 영향을 주는 상황인데,

이 방법을 쓰면 각 쓰레드 별로 다른 변수를 보관하고 있기 때문에 동시성 문제가 해결이 된다.

자바의 generic과 곁들여 사용하면 되고, 코드 예시는 아래와 같다.

`private ThreadLocal<String> threadLocalVariable = new ThreadLocal<>();` 와 같이 사용하면 된다.

이렇게 하면 멀티 쓰레딩으로 동작을 하게 하면서도, 동시성 이슈를 해결할 수 있어서 괜찮은 방법인 것 같다.

**[ 주의점 ]**

**ThreadLocal을 사용하고 나서는 반드시 ThreadLocal.remove()를 통해서 저장된 데이터를 제거 해야 한다.**

쓰레드는 생성비용이 비싸기 때문에 많은 프레임 워크들이 쓰레드 풀에 미리 쓰레드를 생성해놓고,

재사용하는 방식을 사용한다. 이러한 상황에서 `ThreadLocal`에 할당된 데이터를 지우지 않으면 어떻게될까?

요청을 전부 처리한 쓰레드가 `ThreadLocal`이 비워지지 않은채로 쓰레드 풀에 들어갔다가, 이후에 다시 사용이 된다면?

서로 다른 별개의 요청인데도, 이전에 실행된 요청에의해 이후의 요청이 영향을 받는 상황이 발생한다. 

그렇기 때문에 꼭 ThreadLocal을 사용하면 하나의 처리가 끝나면, `.remove()` 메서드를 호출해 지워주도록 하자!

스프링에서는 필터나 인터셉터에서 지우는 방식을 사용하는 것 같다. (maybe?)

# DB자원에서 발생하는 Race Condition을 해결하는 방법

### 1. `synchronized`

서버가 하나이고, 트래픽도 별로없다면 `synchronzied` 를 사용해서 해결이 되기는 한다.

**다만 이 방법은 하나의 프로세스 안에서만 보장되고, 서버가 여러대인 분산환경에서는 Race Condition을 해결할 수 없다.**

### 2. 비관적락 (PessimisticLock)

### 3. 낙관적락 (OptimisticLock)

### 4. NamedLock

### 5. 레디스를 이용한 락




